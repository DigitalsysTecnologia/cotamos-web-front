image: node:carbon-jessie

cache:
  paths:
  - node_modules/

stages:
  - build
  - deploy

build_stage:
  artifacts:
    paths:
      - dist/  
  stage: build
  script:
   - npm install
   - npm run generate
  only:
    refs:
      - master

deploy_stage:
  stage: deploy
  variables:
   DEPLOY_USER: "ubuntu" 
   DEPLOY_URL: "18.213.114.117"
   DEPLOY_DIR: "/var/www/www_cotamos"
  before_script:
   - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
   - 'which zip || ( apt-get update -y && apt-get install zip -y )'
   - echo "$SSH_KEY" > ssh_key
   - chmod 400 ssh_key
   - ssh -i ssh_key -o StrictHostKeyChecking=no ubuntu@18.213.114.117 uptime
  script:
   - mv dist/ deploy/
   - zip -r deploy.zip deploy/*
   - scp -i ssh_key deploy.zip $DEPLOY_USER@$DEPLOY_URL:$DEPLOY_DIR/
   - ssh -i ssh_key $DEPLOY_USER@$DEPLOY_URL 'unzip -o $DEPLOY_DIR/deploy.zip -d $DEPLOY_DIR'
   - ssh -i ssh_key $DEPLOY_USER@$DEPLOY_URL 'cp -rf $DEPLOY_DIR/deploy/* $DEPLOY_DIR'
   - ssh -i ssh_key $DEPLOY_USER@$DEPLOY_URL 'rm $DEPLOY_DIR/deploy.zip'